import os, json
from pyrogram import Client, filters
from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton

API_ID = 1461182
API_HASH = "570d4e2fbabbf3cad6b3db104bc0409d"
BOT_TOKEN = "1636264272:AAFAz39UQWm11izIRHc4MraQjsRxujidWdg" #INSERISCI BOT TOKEN
DEFAULT_ADMINS = [953365075] #INSERISCI UNO O PIU' FOUNDER ID SEPARATI DA VIRGOLE
CHANNEL = "https://t.me/AntistormChanne" #INSERISCI CANALE ! IMPORTANTE ! INSERIRLO SENZA LA @ DAVANTI

# CARICAMENTO SALVATAGGI #
if os.path.exists("storage.json"):
    with open("storage.json", "r+") as f:
        SAVES = json.load(f)
else:
    SAVES = {"Groups": [], "stormer": [], "Staff": DEFAULT_ADMINS}
    with open("storage.json", "w+") as f:
        json.dump(SAVES, f)
    

def save():
    global SAVES
    with open("storage.json", "w+") as f:
        json.dump(SAVES, f)
    

###########################

bot = Client("session", API_ID, API_HASH, bot_token=BOT_TOKEN)

@bot.on_message(filters.new_chat_members)
async def joinManager(client, message):
    global SAVES
    for user in message.new_chat_members:
        if user.is_self:
            if not message.chat.id in SAVES["Groups"]:
                # MESSAGGIO APPENA METTI IL BOT NEL GRUPPO
                await message.reply_text("**Grazie per avermi aggiunto, per usare tutte le funzioni del bot mettimi admin e invia il comando /done**")
        elif message.chat.id in SAVES["Groups"] and not user.is_bot:
            if user.id in SAVES["Stormer"]:
                await client.kick_chat_member(message.chat.id, user.id)
                if user.username == None:
                    if user.last_name == None:
                        mention = f"[{user.first_name}](tg://user?id={user.id})"
                    else:
                        mention = f"[{user.first_name} {user.last_name}](tg://user?id={user.id})"
                else:
                    mention = "@" + user.username
                # # MESSAGGIO QUANDO ENTRA UNO Stormer
                await message.reply_text(f"‚ö†Ô∏è {mention} **era uno Stormer ed √® stato bannato ‚ö†Ô∏è**")
            
        
    

@bot.on_message(filters.text)
async def commandsManager(client, message):
    global SAVES, CHANNEL   
    if message.text.startswith("/admin"):
     if message.from_user.id in SAVES["Staff"]:
        if message.reply_to_message == None:
            st = message.text.split(" ")
            if st.__len__() == 2:
                try:
                    usr = await client.get_users(st[1])
                    if usr == None:
                        await message.reply_text("**‚ö†Ô∏è Utente Non Trovato ‚ö†Ô∏è**")
                        return
                    else:
                        ID = usr.id
                except:
                    await message.reply_text("**‚ö†Ô∏è Utente Non Trovato ‚ö†Ô∏è**")
                    return
            else:
                await message.reply_text("**‚ö†Ô∏è Specificare l' ID o la @ dell' utente ‚ö†Ô∏è**")
                return
        else:
            ID = message.reply_to_message.from_user.id
        if not ID in SAVES["Staff"]:
            SAVES["Staff"].append(ID)
            save()
            await message.reply_text("**‚úÖ Utente reso amministratore ‚úÖ**")
            try:
                await client.send_message(ID, "**üëë Sei stato reso amministratore üëë**")
            except:
                pass
        else:
            await message.reply_text("**‚ö†Ô∏è Quest utente √® gi√† admin ‚ö†Ô∏è**")
    elif message.text.startswith("/unadmin"):
        if message.reply_to_message == None:
            st = message.text.split(" ")
            if st.__len__() == 2:
                try:
                    usr = await client.get_users(st[1])
                    if usr == None:
                        await message.reply_text("**‚ö†Ô∏è Utente Non Trovato ‚ö†Ô∏è**")
                        return
                    else:
                        ID = usr.id
                except:
                    await message.reply_text("**‚ö†Ô∏è Utente Non Trovato ‚ö†Ô∏è**")
                    return
            else:
                await message.reply_text("**‚ö†Ô∏è Specificare l' ID o la @ dell' utente ‚ö†Ô∏è**")
                return
        else:
            ID = message.reply_to_message.from_user.id
        if ID in SAVES["Staff"]:
            SAVES["Staff"].remove(ID)
            save()
            await message.reply_text("**‚úÖ Utente rimosso dagli amministratori ‚úÖ**")
            try:
                await client.send_message(ID, "**‚õîÔ∏è Sei stato rimosso dagli amministratori ‚õîÔ∏è**")
            except:
                pass
        else:
            await message.reply_text("**‚ö†Ô∏è Quest utente non √® admin ‚ö†Ô∏è**")
    elif message.text.startswith("/netban"):
        if message.from_user.id in SAVES["Staff"]:
            st = message.text.split(" ")
            if st.__len__() == 3 and st[2].startswith("http"):
                if st[1].isnumeric():
                    user = int(st[1])
                else:
                    user = st[1]
                try:
                    usr = await client.get_users(user)
                    if usr == None:
                        await message.reply_text("**‚ö†Ô∏è Utente Non Trovato ‚ö†Ô∏è**")
                        return
                except:
                    await message.reply_text("**‚ö†Ô∏è Utente Non Trovato ‚ö†Ô∏è**")
                    return
                if not usr.id in SAVES["Stormer"]:
                    if message.from_user.username == None:
                        if message.from_user.last_name == None:
                            admin = f"[{message.from_user.first_name}](tg://user?id={message.from_user.id})"
                        else:
                            admin = f"[{message.from_user.first_name} {message.from_user.last_name}](tg://user?id={message.from_user.id})"
                    else:
                        admin = "@" + message.from_user.username
                    msg = await message.reply_text("__Netban in corso...__")
                    if usr.username == None:
                        if usr.last_name == None:
                            mention = f"[{usr.first_name}](tg://user?id={usr.id})"
                        else:
                            mention = f"[{usr.first_name} {usr.last_name}](tg://user?id={usr.id})"
                    else:
                        mention = "@" + usr.username
                    c = 0
                    for group in SAVES["Groups"]:
                        try:
                            await client.kick_chat_member(group, usr.id)
                            # MESSAGGIO NETBAN
                            await client.send_message(group, f"‚ö†Ô∏è UTENTE NETBANNATO PER Storm ‚ö†Ô∏è\n\nüë±üèª‚Äç‚ôÇ Utente ¬ª {mention}\nüÜî ID ¬ª `{usr.id}`\nüëÆüèª‚Äç‚ôÇ Supporter ¬ª {admin}", reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üìù Prove", url=st[2])]]))
                            c += 1
                        except:
                            await client.send_message(group, "**‚ö†Ô∏è Per funzionare al meglio il bot ha bisogno dei permessi admin ‚ö†Ô∏è**")
                    await msg.edit(f"**‚úÖ Utente netbannato correttamente in {c} gruppi ‚úÖ**")
                    # MESSAGGIO NETBAN CAMBIARE ANCHE QUI
                    await client.send_message(CHANNEL, f"‚ö†Ô∏è UTENTE NETBANNATO PER Storm ‚ö†Ô∏è\n\nüë±üèª‚Äç‚ôÇ Utente ¬ª {mention}\nüÜî ID ¬ª `{usr.id}`\nüëÆüèª‚Äç‚ôÇ Supporter ¬ª {admin}", reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üìù Prove", url=st[2])]]))
                    SAVES["Stormer"].append(usr.id)
                    save()
                else:
                    await message.reply_text("**‚ö†Ô∏è Utente gi√† netbannato ‚ö†Ô∏è**")
            else:
                await message.reply_text("**‚ö†Ô∏è Sintassi Errata ‚ö†Ô∏è**")
    elif message.text.startswith("/netunban"):
        if message.from_user.id in SAVES["Staff"]:
            st = message.text.split(" ")
            if st.__len__() == 2:
                if st[1].isnumeric():
                    user = int(st[1])
                else:
                    user = st[1]
                try:
                    usr = await client.get_users(user)
                    if usr == None:
                        await message.reply_text("**‚ö†Ô∏è Utente Non Trovato ‚ö†Ô∏è**")
                        return
                except:
                    await message.reply_text("**‚ö†Ô∏è Utente Non Trovato ‚ö†Ô∏è**")
                    return
                if usr.id in SAVES["Stormer"]:
                    if message.from_user.username == None:
                        if message.from_user.last_name == None:
                            admin = f"[{message.from_user.first_name}](tg://user?id={message.from_user.id})"
                        else:
                            admin = f"[{message.from_user.first_name} {message.from_user.last_name}](tg://user?id={message.from_user.id})"
                    else:
                        admin = "@" + message.from_user.username
                    msg = await message.reply_text("__NetUnban in corso...__")
                    if usr.username == None:
                        if usr.last_name == None:
                            mention = f"[{usr.first_name}](tg://user?id={usr.id})"
                        else:
                            mention = f"[{usr.first_name} {usr.last_name}](tg://user?id={usr.id})"
                    else:
                        mention = "@" + usr.username
                    c = 0
                    for group in SAVES["Groups"]:
                        try:
                            await client.unban_chat_member(group, usr.id)
                            # MESSAGGIO SBAN
                            await client.send_message(group, f"‚úÖ UTENTE SBANNATO ‚úÖ\n\nüë±üèª‚Äç‚ôÇ Utente ¬ª {mention}\nüÜî ID ¬ª `{usr.id}`\nüëÆüèª‚Äç‚ôÇ Supporter ¬ª {admin}")
                            c += 1
                        except:
                            await client.send_message(group, "**‚ö†Ô∏è Per funzionare al meglio il bot ha bisogno dei permessi admin ‚ö†Ô∏è**")
                    await msg.edit(f"**‚úÖ Utente sbannato correttamente in {c} gruppi ‚úÖ**")
                    # MESSAGGIO SBAN CAMBIARE ANCHE QUI
                    await client.send_message(CHANNEL, f"‚úÖ UTENTE SBANNATO ‚úÖ\n\nüë±üèª‚Äç‚ôÇ Utente ¬ª {mention}\nüÜî ID ¬ª `{usr.id}`\nüëÆüèª‚Äç‚ôÇ Supporter ¬ª {admin}")
                    SAVES["Stormer"].remove(usr.id)
                    save()
                else:
                    await message.reply_text("**‚ö†Ô∏è Quest utente non √® netbannato ‚ö†Ô∏è**")
            else:
                await message.reply_text("**‚ö†Ô∏è Sintassi Errata ‚ö†Ô∏è**")
    elif message.text.startswith("/check"):
        st = message.text.split(" ", 1)
        if st.__len__() == 2:
            if st[1].isnumeric():
                ID = int(st[1])
            else:
                try:
                    usr = await client.get_users(st[1])
                    if usr == None:
                        await message.reply_text("‚ö†**Ô∏è Utente non trovato ‚ö†Ô∏è**")
                        return
                    else:
                        ID = usr.id
                except:
                    await message.reply_text("‚ö†**Ô∏è Utente non trovato ‚ö†Ô∏è**")
                    return
            if ID in SAVES["Stormer"]:
                # MESSAGGIO CHECK Stormer Stormer
                await message.reply_text("‚ö†**Ô∏è QUEST UTENTE E' UNO Stormer‚ö†Ô∏è**")
            else:
                # MESSAGGIO CHECK SCAMER NON SCAMMER
                await message.reply_text("**‚úÖ Quest utente non √® uno stormer ‚úÖ**")
    elif message.chat.type == "private":
        if message.text == "/start":
            if message.chat.username == None:
                if message.chat.last_name == None:
                    mention = f"[{message.chat.first_name}](tg://user?id={message.chat.id})"
                else:
                    mention = f"[{message.chat.first_name} {message.chat.last_name}](tg://user?id={message.chat.id})"
            else:
                mention = "@" + message.chat.username
            # MESSAGGIO BENVENUTO CON BOTTONI
            await message.reply_text(f"__Benvenuto__ {mention} __nel bot antistorm!__", reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚ûï Aggiungimi in un gruppo ‚ûï", url="https://t.me/" + (await client.get_me()).username + "/?startgroup=startgroup")], [InlineKeyboardButton("üîé Check Scammer", "check")], [InlineKeyboardButton("üì¢ Canale", url="https://t.me/" + CHANNEL), InlineKeyboardButton("üëë Staff", "staff")], [InlineKeyboardButton("‚öôÔ∏è Developer", url="https://t.me/4MSIX")]]))
    elif message.text.startswith("/done"):
        if not message.chat.id in SAVES["Groups"]:
            if (await client.get_chat_member(message.chat.id, "me")).status == "administrator":
                await message.reply_text("**‚úÖ Bot Aggiunto Correttamente ‚úÖ**")
                SAVES["Groups"].append(message.chat.id)
                save()
            else:
                await message.reply_text("**‚ö†Ô∏è Mettere il bot amministratore ‚ö†Ô∏è**")
            
        
    

@bot.on_callback_query()
async def callbackQueryManaer(client, query):
    global SAVES, CHANNEL
    if query.data == "back":
        if query.message.chat.username == None:
            if query.message.chat.last_name == None:
                mention = f"[{query.message.chat.first_name}](tg://user?id={query.message.chat.id})"
            else:
                mention = f"[{query.message.chat.first_name} {query.message.chat.last_name}](tg://user?id={query.message.chat.id})"
        else:
            mention = "@" + query.message.chat.username
        # MESSAGGIO BENVENUTO CON BOTTONI CAMBIARE ANCHE QUI
        await query.message.edit(f"__Benvenuto__ {mention} __nel bot antistorm!__", reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚ûï Aggiungimi in un gruppo ‚ûï", url="https://t.me/" + (await client.get_me()).username + "/?startgroup=startgroup")], [InlineKeyboardButton("üîé Check Scammer", "check")], [InlineKeyboardButton("üì¢ Canale", url="https://t.me/" + CHANNEL), InlineKeyboardButton("üëë Staff", "staff")], [InlineKeyboardButton("‚öôÔ∏è Developer", url="https://t.me/AMS1X")]]))
    elif query.data == "staff":
        # MESSAGGIO LISTA STAFF
        msg = "**üëë LISTA STAFF üëë**\n"
        for admin in SAVES["Staff"]:
            try:
                usr = await client.get_users(admin)
                if usr == None:
                    canMention = False
                else:
                    canMention = True
            except:
                canMention = False
            if canMention:
                if usr.username == None:
                    if usr.last_name == None:
                        mention = f"[{usr.first_name}](tg://user?id={usr.id})"
                    else:
                        mention = f"[{usr.first_name} {usr.last_name}](tg://user?id={usr.id})"
                else:
                    mention = "@" + usr.username
            else:
                mention = "???"
            msg += f"\n{mention} | `{admin}`"
        await query.message.edit(msg, reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô Indietro", "back")]]))
    elif query.data == "check":
        # MESSAGGIO CHECK STORMER
        await query.message.edit("**Per controllare se un utente √® presente nella nostra blacklist devi semplicemente digitare /check [@ o ID]!\n\nEsempio: /check 12312312311**", reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô Indietro", "back")]]))
    

print("Bot Avviato Correttamente!")

bot.run()

# # # Source By @LightYagami32